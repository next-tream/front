name: CI/CD to AWS EC2

on:
  pull_request:
    branches:
      - main  # mainìœ¼ë¡œ PR ì‹œ ì‹¤í–‰
  push:
    branches:
      - main  # mainì— ë³‘í•©ëœ í›„ ì‹¤í–‰

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Node.js ë° Yarn ì„¤ì •
      - name: Setup Node.js and Yarn
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ ì‹¤í–‰
      - name: Install and Build
        run: |
          yarn install
          yarn build

      # 4. ë¹Œë“œ ê²€ì¦ (Pull Request ì‹œë§Œ ì‹¤í–‰)
      - name: Verify Build Success
        if: github.event_name == 'pull_request'
        run: echo "âœ… Build verification successful for PR."

      # 5. AWS EC2ì— ë°°í¬ (Push to main ì‹œë§Œ ì‹¤í–‰)
      - name: Deploy to AWS EC2
        if: github.event_name == 'push'
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_KEY }}
          source: .next/
          target: /home/${{ secrets.AWS_USERNAME }}/nextapp/.next

      # 6. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ (Push to main ì‹œë§Œ ì‹¤í–‰)
      - name: Restart Application on EC2
        if: github.event_name == 'push'
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_KEY }}
          script: |
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
            cd /home/${{ secrets.AWS_USERNAME }}/nextapp
            yarn install --production
            echo "âœ… Restarting application using PM2..."
            pm2 restart nextapp || pm2 start yarn --name "nextapp" -- start
            echo "ğŸš€ Application successfully deployed and restarted."
          debug: true
