name: CI/CD to AWS EC2

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Node.js ë° Yarn ì„¤ì •
      - name: Setup Node.js and Yarn
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ ì‹¤í–‰
      - name: Install and Build
        run: |
          yarn install --frozen-lockfile
          yarn build

      # 4. SSH Key ì„¤ì •
      - name: Set up SSH Key
        run: |
          echo "${{ secrets.AWS_KEY }}" > aws_key.pem
          chmod 600 aws_key.pem

      # 5. AWS EC2ì— ë°°í¬ (src í¬í•¨)
      - name: Deploy to AWS EC2
        run: |
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -i aws_key.pem" \
          .next public src package.json yarn.lock \
          ec2-user@${{ secrets.AWS_HOST }}:/home/ec2-user/nextream-front/

      # 6. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ ë° ìƒíƒœ í™•ì¸
      - name: Restart Application on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -i aws_key.pem ec2-user@${{ secrets.AWS_HOST }} << 'EOF'
          set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
          cd /home/ec2-user/nextream-front
          echo "âœ… Installing dependencies..."
          yarn install --production=false
          echo "âœ… Rebuilding project..."
          yarn build
          echo "âœ… Deleting old PM2 process..."
          pm2 delete nextream-front || true
          echo "âœ… Starting application using PM2..."
          pm2 start yarn --name "nextream-front" -- start
          echo "âœ… Saving PM2 state..."
          pm2 save
          echo "ğŸš€ Application successfully deployed and restarted."
          EOF
