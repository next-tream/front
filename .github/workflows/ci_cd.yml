name: CI/CD to AWS EC2

on:
  push:
    branches:
      - main  # mainì— ë³‘í•©ëœ í›„ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Node.js ë° Yarn ì„¤ì •
      - name: Setup Node.js and Yarn
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ ì‹¤í–‰
      - name: Install and Build
        run: |
          yarn install
          yarn build

      # 4. AWS EC2ì— ë°°í¬
      - name: Deploy to AWS EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_KEY }}
          source: .next/  # ë¹Œë“œëœ íŒŒì¼ë§Œ ì „ì†¡
          target: /home/${{ secrets.AWS_USERNAME }}/nextream-front/.next
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ ë° ìƒíƒœ í™•ì¸
      - name: Restart Application on EC2
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_KEY }}
          script: |
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
            cd /home/${{ secrets.AWS_USERNAME }}/nextream-front
            echo "âœ… Installing dependencies..."
            yarn install --production
            echo "âœ… Restarting application using PM2..."
            pm2 restart nextream-front || pm2 start yarn --name "nextream-front" -- start
            echo "âœ… Saving PM2 state..."
            pm2 save
            echo "ğŸš€ Application successfully deployed and restarted."
