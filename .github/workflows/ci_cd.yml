name: CI/CD to AWS EC2

on:
  push:
    branches:
      - main  # main에 병합된 후 실행

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Node.js 및 Yarn 설정
      - name: Setup Node.js and Yarn
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      # 3. 의존성 설치 및 빌드 실행
      - name: Install and Build
        run: |
          yarn install
          yarn build

      # 4. AWS EC2에 배포
      - name: Deploy to AWS EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_KEY }}
          source: .next/  # 빌드된 파일만 전송
          target: /home/${{ secrets.AWS_USERNAME }}/nextream-front/.next
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5. 애플리케이션 재시작 및 상태 확인
      - name: Restart Application on EC2
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_KEY }}
          script: |
            set -e  # 에러 발생 시 즉시 종료
            cd /home/${{ secrets.AWS_USERNAME }}/nextream-front
            echo "✅ Installing dependencies..."
            yarn install --production
            echo "✅ Restarting application using PM2..."
            pm2 restart nextream-front || pm2 start yarn --name "nextream-front" -- start
            echo "✅ Saving PM2 state..."
            pm2 save
            echo "🚀 Application successfully deployed and restarted."
