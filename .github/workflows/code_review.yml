name: AI Code Review and Build Check

on:
  pull_request:
    branches:
      - dev  # dev ë¸Œëœì¹˜ì— ëŒ€í•œ PRì—ì„œë§Œ ì‹¤í–‰

jobs:
  code-review-and-build:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Node.js ë° Yarn ì„¤ì •
      - name: Setup Node.js and Yarn
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      # 4. ë³€ê²½ëœ ì½”ë“œ ì¶”ì¶œ
      - name: Get Diff of PR
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt
          echo "ë³€ê²½ëœ ì½”ë“œ:"
          cat pr_diff.txt

      # 5. OpenAI API í˜¸ì¶œ (í•œêµ­ì–´ ì‘ë‹µ ìš”ì²­)
      - name: Call OpenAI API for Code Review
        id: review
        run: |
          echo "OpenAI APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì½”ë“œ ë¦¬ë·°ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤..."
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d '{
              "model": "gpt-4",
              "messages": [
                {"role": "system", "content": "ë‹¹ì‹ ì€ í•œêµ­ì–´ë¡œ ì‘ë‹µí•˜ëŠ” ì „ë¬¸ ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤. ë‹¤ìŒ ì½”ë“œ ë³€ê²½ ì‚¬í•­ì„ ë¦¬ë·°í•˜ê³ , ê°œì„  ì‚¬í•­ì´ë‚˜ ì£¼ì˜í•  ì ì„ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”. ë˜í•œ ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆì„ ê²½ìš° í•´ë‹¹ ë¬¸ì œì ì„ ê°„ëµíˆ ì„¤ëª…í•´ì£¼ì„¸ìš”."},
                {"role": "user", "content": "'"$(cat pr_diff.txt)"'"}
              ],
              "temperature": 0.3
            }' | jq -r '.choices[0].message.content')

          echo "REVIEW_OUTPUT<<EOF" >> $GITHUB_ENV
          echo "$RESPONSE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 6. GitHub PRì— ì½”ë“œ ë¦¬ë·° í”¼ë“œë°± ì¶”ê°€
      - name: Add AI Review Comment to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "ğŸ§‘â€ğŸ’» AI ì½”ë“œ ë¦¬ë·° ë° ë¹Œë“œ ê²€ì¦ ê²°ê³¼"
          message: |
            **ğŸ” ì½”ë“œ ë¦¬ë·° ê²°ê³¼:**
            ${{ env.REVIEW_OUTPUT }}
            ---
            **ğŸ”¨ ë¹Œë“œ ìƒíƒœ:** ${{ env.BUILD_STATUS == 'SUCCESS' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}
