name: AI Code Review

on:
  pull_request:
    branches:
      - dev  # dev ë¸Œëœì¹˜ì— ëŒ€í•œ PRì—ì„œë§Œ ì‹¤í–‰

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Node.js ë° Yarn ì„¤ì •
      - name: Setup Node.js and Yarn
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      # 3. ë³€ê²½ëœ ì½”ë“œ ì¶”ì¶œ
      - name: Get Diff of PR
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt
          echo "ë³€ê²½ëœ ì½”ë“œ:"
          cat pr_diff.txt

      # 4. ì½”ë“œ ë¦¬ë·° í”„ë¡¬í”„íŠ¸ ì¤€ë¹„
      - name: Prepare Review Prompt
        run: |
          echo "AI ì½”ë“œ ë¦¬ë·° í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
          echo "ë‹¤ìŒì€ ì½”ë“œ ë¦¬ë·° ìš”ì²­ ì‚¬í•­ì…ë‹ˆë‹¤:" > review_prompt.txt
          echo "" >> review_prompt.txt
          echo "### ì½”ë“œ ë¦¬ë·° ìš”ì²­:" >> review_prompt.txt
          cat pr_diff.txt >> review_prompt.txt
          echo "" >> review_prompt.txt
          echo "### ë¦¬ë·° ì§€ì¹¨:" >> review_prompt.txt
          echo "- ëª…í™•í•œ ì½”ë“œ ê°€ë…ì„± í‰ê°€" >> review_prompt.txt
          echo "- ì˜ëª»ëœ ë„¤ì´ë°ì´ë‚˜ ë¶ˆí•„ìš”í•œ ì½”ë“œ ì œê±°" >> review_prompt.txt
          echo "- TailwindCSS í´ë˜ìŠ¤ ì˜¤ë¥˜ ê²€í† " >> review_prompt.txt
          echo "- ê°„ë‹¨í•œ ê°œì„  ì‚¬í•­ ì œì•ˆ" >> review_prompt.txt
          echo "### ì‘ë‹µ ì–¸ì–´: í•œêµ­ì–´" >> review_prompt.txt

      # 5. OpenAI API í˜¸ì¶œ (review_prompt.txt ì‚¬ìš©)
      - name: Call OpenAI API for Code Review
        id: review
        run: |
          echo "OpenAI APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì½”ë“œ ë¦¬ë·°ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤..."
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d '{
              "model": "gpt-4",
              "messages": [
                {"role": "system", "content": "ë‹¹ì‹ ì€ ì „ë¬¸ ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ì½”ë“œ ë³€ê²½ ì‚¬í•­ì„ ê²€í† í•˜ê³  í•œêµ­ì–´ë¡œ í”¼ë“œë°±ì„ ì‘ì„±í•˜ì„¸ìš”."},
                {"role": "user", "content": "'"$(cat review_prompt.txt)"'"}
              ],
              "temperature": 0.3
            }' | jq -r '.choices[0].message.content')

          echo "REVIEW_OUTPUT<<EOF" >> $GITHUB_ENV
          echo "$RESPONSE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 6. GitHub PRì— ì½”ë“œ ë¦¬ë·° í”¼ë“œë°± ì¶”ê°€
      - name: Add AI Review Comment to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "ğŸ§‘â€ğŸ’» AI ì½”ë“œ ë¦¬ë·° ê²°ê³¼"
          message: |
            **ğŸ” ì½”ë“œ ë¦¬ë·° ê²°ê³¼:**
            ${{ env.REVIEW_OUTPUT }}
