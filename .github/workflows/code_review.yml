name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì „ì²´ ì´ë ¥ ê°€ì ¸ì˜¤ê¸°)
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. ë””ë²„ê¹…: í˜„ì¬ ë¸Œëœì¹˜ ë° ì›ê²© ìƒíƒœ í™•ì¸
      - name: Debug Current Branch
        run: |
          echo "### Debugging Branch Information"
          git branch -a
          git remote -v

      # 3. ë³€ê²½ëœ ì½”ë“œ ì¶”ì¶œ
      - name: Get Diff of PR
        id: diff
        run: |
          echo "### Fetching the diff between dev and HEAD..."
          git fetch --no-tags --prune --depth=1 origin +refs/heads/dev:refs/remotes/origin/dev
          git diff origin/dev...HEAD > pr_diff.txt
          echo "### Changed Code:"
          cat pr_diff.txt

      # 4. OpenAI API í˜¸ì¶œ ë° ì—ëŸ¬ ë¡œê·¸ ì¶œë ¥
      - name: Call OpenAI API for Code Review
        id: review
        run: |
          echo "### Calling OpenAI API for Code Review..."

          # pr_diff.txt ë‚´ìš©ì„ JSON-safe ë¬¸ìì—´ë¡œ ë³€í™˜
          DIFF_CONTENT=$(jq -Rs . < pr_diff.txt)

          # OpenAI API í˜¸ì¶œ
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d '{
              "model": "gpt-4",
              "messages": [
                {"role": "system", "content": "You are a professional code reviewer. Review the following code changes and provide concise, constructive feedback."},
                {"role": "user", "content": '"$DIFF_CONTENT"'}
              ],
              "temperature": 0.3
            }')

          # API ì‘ë‹µê³¼ HTTP ìƒíƒœ ì½”ë“œ ì¶œë ¥
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d ":" -f2)
          API_BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')

          echo "### API Raw Response:"
          echo "$API_BODY"

          echo "### HTTP Status Code:"
          echo "$HTTP_STATUS"

          # HTTP ìƒíƒœ ì½”ë“œ í™•ì¸
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "âŒ OpenAI API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP $HTTP_STATUS)"
            exit 1
          fi

          # API ì‘ë‹µì—ì„œ message.content ì¶”ì¶œ
          REVIEW_CONTENT=$(echo "$API_BODY" | jq -r '.choices[0].message.content // "No feedback returned from OpenAI API."')

          echo "REVIEW_OUTPUT<<EOF" >> $GITHUB_ENV
          echo "$REVIEW_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "### Final Review Output:"
          echo "$REVIEW_CONTENT"

      # 5. GitHub PR ì½”ë©˜íŠ¸ ì¶”ê°€
      - name: Add Review Comment to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: AI Code Review
          message: |
            ğŸ‘¨â€ğŸ’» **AI Code Review Feedback**:
            ---
            ${{ env.REVIEW_OUTPUT }}
